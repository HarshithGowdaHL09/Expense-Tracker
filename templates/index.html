<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Expense Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4f46e5',
                        secondary: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>

<body class="bg-slate-100 text-slate-800 font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto space-y-6">

        <!-- Header & Top Actions -->
        <header
            class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3">
                <div class="bg-primary p-3 rounded-xl shadow-lg shadow-primary/30 text-white">
                    <i data-lucide="layout-dashboard" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">Expense Dashboard</h1>
                    <p class="text-slate-500 text-sm" id="topInsight">Welcome back! Let's track your spending.</p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="openBudgetModal()"
                    class="flex items-center gap-2 bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    <i data-lucide="target" class="w-4 h-4"></i> Set Budgets
                </button>
                <button onclick="exportToCSV()"
                    class="flex items-center gap-2 bg-secondary hover:bg-emerald-600 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-sm">
                    <i data-lucide="download" class="w-4 h-4"></i> Export CSV
                </button>
            </div>
        </header>

        <!-- Dynamic Alerts (Budget Warnings) -->
        <div id="alertContainer" class="space-y-2"></div>

        <!-- 5-Column Summary Cards (Powered by /summary API) -->
        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
            <!-- Today's Expenses -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">Today</p>
                        <h2 class="text-3xl font-bold text-slate-900 mt-1">‚Çπ<span id="dayTotal">0.00</span></h2>
                    </div>
                    <div class="bg-indigo-50 p-2 rounded-lg text-primary"><i data-lucide="calendar" class="w-6 h-6"></i>
                    </div>
                </div>
            </div>
            <!-- This Week -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">This Week</p>
                        <h2 class="text-3xl font-bold text-primary mt-1">‚Çπ<span id="weekTotal">0.00</span></h2>
                    </div>
                    <div class="bg-blue-50 p-2 rounded-lg text-blue-600"><i data-lucide="calendar-days"
                            class="w-6 h-6"></i></div>
                </div>
            </div>
            <!-- This Month -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">This Month</p>
                        <h2 class="text-3xl font-bold text-danger mt-1">‚Çπ<span id="monthTotal">0.00</span></h2>
                    </div>
                    <div class="bg-red-50 p-2 rounded-lg text-danger"><i data-lucide="trending-down"
                            class="w-6 h-6"></i></div>
                </div>
            </div>
            <!-- This Year -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-sm font-medium text-slate-500 uppercase tracking-wider">This Year</p>
                        <h2 class="text-3xl font-bold text-slate-900 mt-1">‚Çπ<span id="yearTotal">0.00</span></h2>
                    </div>
                    <div class="bg-purple-50 p-2 rounded-lg text-purple-600"><i data-lucide="calendar-check"
                            class="w-6 h-6"></i></div>
                </div>
            </div>
            <!-- Monthly Budget Progress -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex flex-col justify-center">
                <div class="flex justify-between text-sm mb-1">
                    <span class="font-medium text-slate-700">Monthly Budget</span>
                    <span class="text-slate-500" id="budgetLabel">‚Çπ0 / ‚Çπ0</span>
                </div>
                <div class="w-full bg-slate-100 rounded-full h-2.5 mb-1 overflow-hidden">
                    <div id="budgetProgressBar" class="bg-primary h-2.5 rounded-full transition-all duration-500"
                        style="width: 0%"></div>
                </div>
                <p id="budgetStatusText" class="text-xs text-slate-500 text-right">0% used</p>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Form -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-primary"></i>
                        Add Expense
                    </h3>

                    <form id="expenseForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Amount (‚Çπ)</label>
                            <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Category</label>
                            <input type="text" id="category" list="categoryOptions" placeholder="e.g. Food, Transport"
                                required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none">
                            <datalist id="categoryOptions">
                                <option value="Food & Dining">
                                <option value="Transportation">
                                <option value="Shopping">
                                <option value="Bills & Utilities">
                                <option value="Entertainment">
                                <option value="Healthcare">
                            </datalist>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Description</label>
                            <input type="text" id="description" placeholder="What was this for?"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Date</label>
                            <input type="date" id="date" required
                                class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary outline-none">
                        </div>

                        <button type="submit"
                            class="w-full bg-primary hover:bg-indigo-700 text-white font-medium py-2.5 rounded-lg transition-colors flex justify-center items-center gap-2 shadow-sm mt-2">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Expense
                        </button>
                    </form>
                </div>
            </div>

            <!-- Middle Column: Charts -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Doughnut Chart (Categories) -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col justify-center items-center h-[320px]">
                    <h3 class="text-sm font-semibold w-full text-left mb-2 text-slate-700">Expense Breakdown</h3>
                    <div class="w-full h-full relative flex justify-center items-center pb-4">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <!-- Line Chart (Trend) -->
                <div
                    class="bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col justify-center items-center h-[320px]">
                    <h3 class="text-sm font-semibold w-full text-left mb-2 text-slate-700">15-Day Spending Trend</h3>
                    <div class="w-full h-full relative flex justify-center items-center pb-4">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Right Column: List -->
            <div class="lg:col-span-1">
                <div
                    class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6 h-full max-h-[665px] flex flex-col">
                    <h3 class="text-lg font-semibold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="list" class="w-5 h-5 text-primary"></i>
                        Recent Expenses
                    </h3>
                    <div class="overflow-y-auto custom-scrollbar pr-2 flex-1">
                        <ul id="expenseList" class="space-y-3">
                            <!-- Items injected here -->
                        </ul>
                        <div id="emptyListMessage" class="text-center py-12 text-slate-400 hidden">
                            <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 opacity-50"></i>
                            <p>No expenses found.</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Budget Settings Modal -->
    <dialog id="budgetModal" class="bg-white rounded-2xl shadow-2xl border border-slate-200 p-0 w-full max-w-md">
        <div class="p-6">
            <h3 class="text-xl font-bold mb-4">Set Budgets</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Overall Monthly Budget</label>
                    <input type="number" id="overallBudgetInput" placeholder="e.g. 50000"
                        class="w-full px-4 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div class="pt-4 border-t border-slate-100">
                    <p class="text-sm font-semibold text-slate-800 mb-2">Category Budgets (Optional)</p>
                    <div class="grid grid-cols-2 gap-2" id="categoryBudgetInputs">
                        <!-- Populated dynamically via JS -->
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button onclick="document.getElementById('budgetModal').close()"
                    class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="saveBudgets()"
                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-indigo-700">Save Budgets</button>
            </div>
        </div>
    </dialog>

    <script>
        lucide.createIcons();

        // Application State
        let expenses = [];
        let summaryData = null;
        let categoryChartInstance = null;
        let trendChartInstance = null;
        let editingId = null;

        // Budgets (Stored locally)
        let budgets = JSON.parse(localStorage.getItem('userBudgets')) || { overall: 0, categories: {} };

        document.getElementById('date').valueAsDate = new Date();

        const formatMoney = (amount) => parseFloat(amount).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // ==========================================
        // üîå DATA FETCHING (Parallel Fetching)
        // ==========================================
        async function fetchDashboardData() {
            try {
                // Fetch full list and summary aggregates simultaneously
                const [expResponse, sumResponse] = await Promise.all([
                    fetch('/get-expenses'),
                    fetch('/summary')
                ]);

                expenses = await expResponse.json();
                summaryData = await sumResponse.json();

                updateUI();
            } catch (error) {
                console.error("Backend fetch failed. Make sure Flask is running.", error);
            }
        }

        function init() { fetchDashboardData(); }

        function updateUI() {
            renderList();
            updateSummaryCards();
            updateCharts();
            checkBudgetAlerts();
        }

        // ==========================================
        // üìä ADVANCED DASHBOARD CALCULATIONS
        // ==========================================
        function updateSummaryCards() {
            if (!summaryData) return;

            document.getElementById('dayTotal').innerText = formatMoney(summaryData.day);
            document.getElementById('weekTotal').innerText = formatMoney(summaryData.week);
            document.getElementById('monthTotal').innerText = formatMoney(summaryData.month);
            document.getElementById('yearTotal').innerText = formatMoney(summaryData.year);

            // Top Category Highlight Insight
            if (summaryData.category.length > 0) {
                const topCat = summaryData.category.reduce((a, b) => a.total > b.total ? a : b);
                document.getElementById('topInsight').innerHTML = `Insight: You spend most on <strong class="text-primary">${topCat.category}</strong> this month.`;
            } else {
                document.getElementById('topInsight').innerText = "Add expenses to see your spending insights.";
            }

            // Budget Progress Bar
            if (budgets.overall > 0) {
                const pct = Math.min((summaryData.month / budgets.overall) * 100, 100);
                const bar = document.getElementById('budgetProgressBar');

                document.getElementById('budgetLabel').innerText = `‚Çπ${formatMoney(summaryData.month)} / ‚Çπ${formatMoney(budgets.overall)}`;
                bar.style.width = `${pct}%`;
                document.getElementById('budgetStatusText').innerText = `${pct.toFixed(1)}% used`;

                if (pct >= 100) bar.className = "bg-danger h-2.5 rounded-full transition-all duration-500";
                else if (pct >= 80) bar.className = "bg-warning h-2.5 rounded-full transition-all duration-500";
                else bar.className = "bg-primary h-2.5 rounded-full transition-all duration-500";
            } else {
                document.getElementById('budgetLabel').innerText = "Not set";
                document.getElementById('budgetProgressBar').style.width = "0%";
                document.getElementById('budgetStatusText').innerText = "0% used";
            }
        }

        // ==========================================
        // ‚ö†Ô∏è BUDGET WARNINGS & ALERTS
        // ==========================================
        function checkBudgetAlerts() {
            if (!summaryData) return;
            const container = document.getElementById('alertContainer');
            container.innerHTML = '';

            // Overall Budget Check
            if (budgets.overall > 0) {
                const pct = (summaryData.month / budgets.overall) * 100;
                if (pct >= 100) createAlert('danger', 'Overall budget exceeded!', `You have spent ‚Çπ${formatMoney(summaryData.month)} out of your ‚Çπ${formatMoney(budgets.overall)} budget.`);
                else if (pct >= 80) createAlert('warning', 'Approaching budget limit!', `You have used ${pct.toFixed(0)}% of your monthly budget.`);
            }

            // Category Budget Check
            const categoryTotals = {};
            summaryData.category.forEach(c => categoryTotals[c.category] = c.total);

            for (const [cat, limit] of Object.entries(budgets.categories)) {
                if (limit > 0 && categoryTotals[cat]) {
                    const catPct = (categoryTotals[cat] / limit) * 100;
                    if (catPct >= 100) createAlert('danger', `${cat} budget exceeded!`, `Spent ‚Çπ${formatMoney(categoryTotals[cat])} (Limit: ‚Çπ${limit})`);
                }
            }
        }

        function createAlert(type, title, desc) {
            const div = document.createElement('div');
            const colors = type === 'danger' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-amber-50 border-amber-200 text-amber-800';
            const icon = type === 'danger' ? 'alert-triangle' : 'alert-circle';

            div.className = `flex items-start gap-3 p-3 rounded-xl border ${colors} mb-2`;
            div.innerHTML = `
                <i data-lucide="${icon}" class="w-5 h-5 shrink-0 mt-0.5"></i>
                <div>
                    <h4 class="text-sm font-bold">${title}</h4>
                    <p class="text-xs opacity-90">${desc}</p>
                </div>
            `;
            document.getElementById('alertContainer').appendChild(div);
            lucide.createIcons();
        }

        // ==========================================
        // üìù FORM SUBMISSION & API CALLS
        // ==========================================
        document.getElementById('expenseForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;

            const payload = {
                amount: parseFloat(document.getElementById('amount').value),
                category: document.getElementById('category').value.trim(),
                description: document.getElementById('description').value.trim() || document.getElementById('category').value,
                date: document.getElementById('date').value
            };

            try {
                if (editingId) {
                    await fetch(`/edit-expense/${editingId}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    editingId = null;
                } else {
                    await fetch('/add-expense', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                }

                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                document.getElementById('amount').focus();

                await fetchDashboardData(); // Refresh all data from DB
            } catch (error) {
                alert("Failed to save. Make sure your Flask backend is running.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Save Expense';
                lucide.createIcons();
            }
        });

        // ==========================================
        // üìà CHARTS (Doughnut & Line)
        // ==========================================
        function updateCharts() {
            updateCategoryChart();
            updateTrendChart();
        }

        function updateCategoryChart() {
            const canvas = document.getElementById('categoryChart');

            if (!summaryData || summaryData.category.length === 0) {
                canvas.style.display = 'none'; return;
            } else { canvas.style.display = 'block'; }

            const labels = summaryData.category.map(c => c.category);
            const data = summaryData.category.map(c => c.total);

            if (categoryChartInstance) categoryChartInstance.destroy();

            categoryChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'],
                        borderWidth: 0,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { boxWidth: 10, font: { size: 10 } } } },
                    cutout: '70%'
                }
            });
        }

        function updateTrendChart() {
            const canvas = document.getElementById('trendChart');
            if (expenses.length === 0) { canvas.style.display = 'none'; return; }
            canvas.style.display = 'block';

            // Group last 15 days expenses by date
            const last15Days = {};
            const today = new Date();
            for (let i = 14; i >= 0; i--) {
                const d = new Date(today); d.setDate(d.getDate() - i);
                last15Days[d.toISOString().split('T')[0]] = 0;
            }

            expenses.forEach(t => {
                if (last15Days[t.date] !== undefined) last15Days[t.date] += parseFloat(t.amount);
            });

            const labels = Object.keys(last15Days).map(date => date.substring(5)); // Show MM-DD
            const data = Object.values(last15Days);

            if (trendChartInstance) trendChartInstance.destroy();

            trendChartInstance = new Chart(canvas.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Expenses',
                        data: data,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 10 } } },
                        y: { border: { display: false }, ticks: { font: { size: 10 } } }
                    }
                }
            });
        }

        // ==========================================
        // üìÑ RENDER LIST
        // ==========================================
        window.deleteExpense = async function (id) {
            if (!confirm("Delete this expense?")) return;
            try {
                await fetch(`/delete-expense/${id}`, { method: 'DELETE' });
                await fetchDashboardData();
            } catch (e) {
                console.error("Deletion failed.");
            }
        };

        window.editExpense = function (id) {
            const exp = expenses.find(e => e.id === id);
            if (!exp) return;
            document.getElementById('amount').value = exp.amount;
            document.getElementById('category').value = exp.category;
            document.getElementById('description').value = exp.description;
            document.getElementById('date').value = exp.date;
            editingId = id;
            document.getElementById('expenseForm').querySelector('button[type="submit"]').innerHTML = '<i data-lucide="save" class="w-4 h-4"></i> Update Expense';
            lucide.createIcons();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        function renderList() {
            const listEl = document.getElementById('expenseList');
            const emptyMsg = document.getElementById('emptyListMessage');
            listEl.innerHTML = '';

            if (expenses.length === 0) {
                emptyMsg.classList.remove('hidden');
            } else {
                emptyMsg.classList.add('hidden');

                expenses.forEach(t => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-3 bg-slate-50 hover:bg-slate-100 border border-slate-100 rounded-xl transition-colors group';

                    li.innerHTML = `
                        <div class="flex items-start gap-3 overflow-hidden">
                            <div class="p-2 border rounded-lg shrink-0 text-slate-500 bg-white border-slate-200">
                                <i data-lucide="receipt" class="w-4 h-4"></i>
                            </div>
                            <div class="min-w-0">
                                <p class="font-semibold text-sm text-slate-800 truncate">${t.description}</p>
                                <div class="flex items-center gap-2 text-xs text-slate-500 mt-0.5">
                                    <span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded-md font-medium">${t.category}</span>
                                    <span>${t.date}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-1 shrink-0 pl-2">
                            <span class="font-bold text-sm mr-2 text-slate-800">-‚Çπ${formatMoney(t.amount)}</span>
                            <button onclick="editExpense(${t.id})" class="text-slate-400 hover:text-blue-500 p-1.5 rounded-lg hover:bg-blue-50 transition-colors" title="Edit"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteExpense(${t.id})" class="text-slate-400 hover:text-red-500 p-1.5 rounded-lg hover:bg-red-50 transition-colors" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </div>
                    `;
                    listEl.appendChild(li);
                });
                lucide.createIcons();
            }
        }

        // ==========================================
        // üì• EXPORT TO CSV
        // ==========================================
        function exportToCSV() {
            if (expenses.length === 0) return alert("No expenses to export.");

            const headers = ["Date", "Category", "Description", "Amount"];
            const csvRows = [headers.join(',')];

            expenses.forEach(t => {
                const row = [t.date, `"${t.category}"`, `"${t.description}"`, t.amount];
                csvRows.push(row.join(','));
            });

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('href', url);
            a.setAttribute('download', `expenses_${new Date().toISOString().split('T')[0]}.csv`);
            a.click();
        }

        // ==========================================
        // üéØ BUDGET MODAL LOGIC
        // ==========================================
        function openBudgetModal() {
            document.getElementById('overallBudgetInput').value = budgets.overall || '';
            const catContainer = document.getElementById('categoryBudgetInputs');
            catContainer.innerHTML = '';

            const uniqueCats = [...new Set(expenses.map(t => t.category))];
            if (uniqueCats.length === 0) catContainer.innerHTML = '<p class="text-xs text-slate-400 col-span-2">Add expenses to set category budgets.</p>';

            uniqueCats.forEach(cat => {
                const val = budgets.categories[cat] || '';
                catContainer.innerHTML += `
                    <div>
                        <label class="block text-xs text-slate-500 mb-1 truncate">${cat}</label>
                        <input type="number" data-cat="${cat}" value="${val}" class="cat-budget-input w-full px-2 py-1.5 text-sm border border-slate-300 rounded outline-none focus:ring-1 focus:ring-primary">
                    </div>
                `;
            });

            document.getElementById('budgetModal').showModal();
        }

        function saveBudgets() {
            budgets.overall = parseFloat(document.getElementById('overallBudgetInput').value) || 0;

            document.querySelectorAll('.cat-budget-input').forEach(input => {
                const cat = input.getAttribute('data-cat');
                const val = parseFloat(input.value) || 0;
                if (val > 0) budgets.categories[cat] = val;
                else delete budgets.categories[cat];
            });

            localStorage.setItem('userBudgets', JSON.stringify(budgets));
            document.getElementById('budgetModal').close();
            updateUI();
        }

        init();
    </script>
</body>

</html>